<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Recycling Locations</title>
    
    <!-- Bootstrap 5 CSS & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME & VARIABLES --- */
        :root {
            --primary-color: #007bff; /* A vibrant blue */
            --secondary-color: #28a745; /* A friendly green */
            --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --panel-bg: rgba(255, 255, 255, 0.85);
            --text-color: #333;
            --header-bg: #2c3e50;
            --header-text: #ecf0f1;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 8px 25px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
        }

        /* --- BASE STYLES --- */
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--background-gradient);
            color: var(--text-color);
            min-height: 100vh;
        }

        /* --- HEADER --- */
        .page-header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 1.5rem 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-strong);
        }
        .page-header h1 {
            font-weight: 700;
            letter-spacing: 1px;
        }
        .page-header i {
            margin-right: 10px;
            color: var(--secondary-color);
        }

        /* --- MAIN CONTENT & PANELS --- */
        .content-panel {
            background-color: var(--panel-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-strong);
            height: 100%;
        }

        /* --- FORM STYLES --- */
        .custom-form .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        
        /* --- BUTTON STYLES --- */
        .btn-show-map {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
        }
        .btn-show-map:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-strong);
        }
        .btn-show-map:disabled {
            background: #aaa;
            cursor: not-allowed;
        }


        /* --- MAP CONTAINER --- */
        .map-container {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden; /* Important for the border-radius on the iframe */
            box-shadow: var(--shadow-strong);
            height: 100%;
            min-height: 500px;
        }
        #mapIframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* --- MAP LOADING OVERLAY --- */
        #map-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        /* --- FOOTER --- */
        .page-footer {
            padding: 1rem;
            margin-top: 2rem;
        }
    </style>
</head>

<body>
    <header class="page-header text-center">
        <h1><i class="bi bi-geo-alt-fill"></i>Find Recycling Locations</h1>
    </header>

    <main class="container">
        <div class="row g-4 align-items-stretch">
            <!-- Form Column -->
            <div class="col-lg-4 col-md-5">
                <div class="content-panel d-flex flex-column justify-content-center">
                    <form id="locationForm" class="custom-form">
                        <div class="mb-4">
                            <label for="location" class="form-label">Enter City</label>
                            <input type="text" class="form-control" id="location" placeholder="e.g., Pekanbaru" value="Pekanbaru">
                        </div>
                        <div class="mb-4">
                            <label for="category" class="form-label">Select Category</label>
                            <select class="form-select" id="category">
                                <option value="banksampah">Bank Sampah (Recycling Bank)</option>
                                <option value="tps">Tempat Pembuangan Sampah (TPS)</option>
                                <option value="TPA">Tempat Pembuangan Akhir (TPA)</option>
                                <option value="sampah">Show All Waste Locations</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="button" id="updateMapBtn" class="btn btn-primary btn-show-map" onclick="updateMap()">
                                <i class="bi bi-search"></i> Show Map
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Map Column -->
            <div class="col-lg-8 col-md-7">
                <div class="map-container">
                    <!-- Loading Spinner Overlay -->
                    <div id="map-loader">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <!-- Iframe for Google Map -->
                    <iframe id="mapIframe"
                        src="https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d31732.412925122622!2d101.4267945!3d0.5282594!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!2m1!1sBank%20Sampah%20di%20Pekanbaru!5e1!3m2!1sid!2sid!4v1683005676790!&t=m"
                        allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
            </div>
        </div>
    </main>

    <footer class="page-footer text-center">
        <p class="small text-muted">Note: Search results may not include all locations.</p>
    </footer>

    <!-- JavaScript section -->
    <script>
        /*
            MAP BREAKDOWN (EXCELLENT ANALYSIS - PRESERVED)
            This breakdown shows how to manipulate the Google Maps embed URL without an API key.
            URL: https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d31732...
            
            Base URL: https://www.google.com/maps/embed?pb=
            
            Parameters after 'pb=':
            !1m16 -> View Mode (16 = places)
               !1m12 -> Parameter count
                  !1m3 -> Start of map scale/position
                     !1d... -> Zoom level (distance)
                     !2d... -> Longitude (THIS IS WHAT WE CHANGE)
                     !3d... -> Latitude (THIS IS WHAT WE CHANGE)
                  !2m3 -> Start of map view angle
                     !1f0, !2f0, !3f0 -> Map direction & tilt
                  !3m2 -> Start of map size
                     !1i1024, !2i768 -> Default pixel dimensions
                  !4f13.1 -> Zoom factor
               !2m1 -> Marker section
                  !1s... -> Marker Name/Search Query (THIS IS WHAT WE CHANGE)
               !5e1 -> Map type (1 = road)
               ...and so on for language, version, etc.
            
            We primarily manipulate Longitude, Latitude, and the Search Query.
        */
        
        // Get references to DOM elements
        const updateMapBtn = document.getElementById('updateMapBtn');
        const mapLoader = document.getElementById('map-loader');
        const mapIframe = document.getElementById('mapIframe');

        function showLoadingState(isLoading) {
            if (isLoading) {
                mapLoader.style.display = 'flex';
                updateMapBtn.disabled = true;
                updateMapBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`;
            } else {
                mapLoader.style.display = 'none';
                updateMapBtn.disabled = false;
                updateMapBtn.innerHTML = `<i class="bi bi-search"></i> Show Map`;
            }
        }
        
        async function updateMap() {
            showLoadingState(true);

            // Get values from the form
            const locationInput = document.getElementById('location').value;
            let category = document.getElementById('category').value;
            let searchQuery = '';

            // Build the search query string
            if (category == 'tps') {
                searchQuery = encodeURIComponent(`Tempat Pembuangan Sampah di ${locationInput}`);
            } else if (category == 'banksampah') {
                searchQuery = encodeURIComponent(`Bank Sampah di ${locationInput}`);
            } else if (category == 'TPA') {
                searchQuery = encodeURIComponent(`Tempat Pembuangan Akhir di ${locationInput}`);
            } else { // 'sampah'
                searchQuery = encodeURIComponent(`Tempat Sampah di ${locationInput}`);
            }

            // Set default coordinates (e.g., center of Pekanbaru)
            let latitude = 0.5187316;
            let longitude = 101.4323738;

            try {
                // If a location is provided, use Geocoding API to get its coordinates
                if (locationInput) {
                    const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(locationInput)}&key=8db57c4a0aa24556813b53a8410823cf`);
                    const data = await response.json();
                    if (data.results.length > 0) {
                        latitude = data.results[0].geometry.lat;
                        longitude = data.results[0].geometry.lng;
                    } else {
                       console.warn("Could not find coordinates for the location:", locationInput);
                    }
                }
                // Update the map URL with the new coordinates and query
                updateMapIframe(searchQuery, latitude, longitude);
            } catch (error) {
                console.error('Error fetching geocoding data:', error);
                alert('Could not fetch location data. Please try again.');
                showLoadingState(false); // Hide loader on error
            }
        }

        function updateMapIframe(searchQuery, latitude, longitude) {
            // Wait for the iframe to fully load before hiding the spinner
            mapIframe.onload = () => {
                showLoadingState(false);
            };
            
            // Construct the new map URL. Using a modern theme 'm' (default) or 'k' (dark).
            const mapTheme = 'm';
            const newSrc = `https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d63464.82585024524!2d${longitude}!3d${latitude}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!2m1!1s${searchQuery}!5e0!3m2!1sen!2sid&t=${mapTheme}`;
            
            mapIframe.src = newSrc;
        }

        // Trigger the map update on initial page load with default values
        document.addEventListener('DOMContentLoaded', () => {
            updateMap();
        });

    </script>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>

</html>
